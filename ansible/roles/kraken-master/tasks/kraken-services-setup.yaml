---
- name: Clean up tiller rc if present
  become: yes
  shell: >
    /opt/bin/kubectl --kubeconfig={{ controller_manager_settings.kubeconfig | expanduser }} delete rc {{ tiller_rc }}
  ignore_errors: yes

- name: Create Helm home
  become: yes
  file: >
    path=/root/.helm
    state=directory

- name: Init helm
  become: yes
  shell: >
    docker run --rm -v /root/.helm:/helm-home -v {{ controller_manager_settings.kubeconfig | expanduser }}:/root/.kube/config {{ helm_image }} init --tiller-image {{ tiller_image }}

- name: Add helm repositories
  shell: >
    docker run --rm -v /root/.helm:/helm-home -v {{ controller_manager_settings.kubeconfig | expanduser }}:/root/.kube/config {{ helm_image }} repo add {{ item.split('|')[0] }} {{ item.split('|')[1] }}
  with_items: "{{ kraken_services_repos.split(' ') }}"

  # TODO: render the custom value yamls